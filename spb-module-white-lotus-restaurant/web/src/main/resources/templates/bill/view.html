<!DOCTYPE html>
<html lang="en">

<head>
    <title>Chi tiết hóa đơn</title>
    <th:block th:replace="layout/head"/>
</head>

<body>

    <!------------- LOADING SPINNER---------->
    <th:block th:replace="layout/loading"/>
    <!------------- LOADING SPINNER---------->

    <!-- SIDEBAR -->
    <th:block th:replace="layout/sidebar"/>
    <!-- SIDEBAR -->

    <!-- CONTENT -->
    <section id="content">
        <!-- NAVBAR -->
        <th:block th:replace="layout/navbar"/>
        <!-- NAVBAR -->

        <!-- MAIN -->
        <main>
            <!------  Main header ----->
            <div class="app-title">
                <div class="app-title-child">
                    <h3>Chi tiết</h3>
                </div>
                <div id="clock"></div>
            </div>
            <!---- End Main header --->
            <div class="cards">
                <div class="row">
                    <div class="col-md-12">

                        <div class="be-content">
                            <div class="main-content container-fluid">
                                <div class="user-profile">
                                    <div class="row">
                                        <div class="col-lg-5">
                                            <div class="user-info-list card">
                                                <div class="card-header card-header-divider text-center" id="orderview">
                                                    <h3>Chi tiết hóa đơn </h3>
                                                    <span class="card-subtitle"></span>
                                                </div>
                                                <div class="card-body">
                                                    <table class="table table-borderless">
                                                        <tbody class="">
                                                        <tr>
                                                            <td class="item">Số:</td>
                                                            <td id="id" class="font-weight-bold"></td>
                                                        </tr>
                                                        <tr>
                                                            <td class="item"> Ngày tháng:</td>
                                                            <td id="createAt" class="font-weight-bold"></td>
                                                        </tr>
                                                        <tr>
                                                            <td class="item">Nhân viên:</td>
                                                            <td id="staff" class="font-weight-bold"></td>
                                                        </tr>
                                                        <tr>
                                                            <td class="item">Bàn:</td>
                                                            <td id="table" class="font-weight-bold"></td>
                                                        </tr>
                                                        <tr>
                                                            <td class="item">Tổng tiền: </td>
                                                            <td id="orderPrice" class="font-weight-bold display-6" style="color: #111111; font-size: 16px"></td>
                                                        </tr>
                                                        <tr>
                                                            <td class="item">Phụ thu: </td>
                                                            <td id="charge" class="font-weight-bold display-6" style="color:#f65a6d ; font-size: 16px"></td>
                                                        </tr>
                                                        <tr>
                                                            <td class="item">Giảm giá: </td>
                                                            <td id="discount" class="font-weight-bold display-6" style="color: #0ee12a; font-size: 16px" ></td>
                                                        </tr>
                                                        <tr>
                                                            <td class="item">Chốt đơn: </td>
                                                            <td id="totalAmount" class="font-weight-bold display-6" style="color: #f6d551; font-size: 24px"><strong></strong></td>
                                                        </tr>
                                                        <tr>
                                                            <td class="item">Trạng thái</td>
                                                            <td id="statusOrder" class="font-weight-bold"></td>
                                                        </tr>
                                                        <tr>
                                                            <td class="item">Thanh toán tiền mặt</td>
                                                            <td id="cashPay" class="font-weight-bold"></td>
                                                        </tr>
                                                        <tr>
                                                            <td class="item">Thanh toán chuyển khoản</td>
                                                            <td id="transferPay" class="font-weight-bold"></td>
                                                        </tr>
                                                        <tr>
                                                            <td class="item"> </td>
                                                            <td >
                                                                <button id="pFile" class="btn  btn-outline-info ml-2 printArea hide" type="button" onclick="printContent('tbBill')">
                                                                <i class="fa-solid fa-print"></i> Xuất hóa đơn
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-7">
                                            <div class="widget widget-fullwidth widget-small">
                                                <div class="widget-chart-container">
                                                    <table class="table table-striped table-hover w-100 " id="tbOrderItems">
                                                        <thead>
                                                        <tr>
                                                            <th class="text-center">HÌnh ảnh</th>
                                                            <th class="text-center">Sản phẩm</th>
                                                            <th class="text-center">Số lượng</th>
                                                            <th class="text-center">Ghi chú</th>
                                                            <th class="text-center">Giá</th>
                                                            <th class="text-center">Thành tiền</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>


                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-50 mx-auto d-none" >
                                        <table id="tbBill" class="table table-bordered w-50">
                                            <thead>
                                            <tr>
                                                <td COLSPAN="5"><h3 class="text-center">WHITE LOTUS RESTAURANT</h3></td>
                                            </tr>
                                            <tr>
                                                <td COLSPAN="5" class="text-center">******<img src="/assets/images/pink-lotus-icon3.png" style="width: 70px; height: auto">******</td>
                                            </tr>
                                            <tr>
                                                <td COLSPAN="5"><h5 class="text-center">28 - Nguyễn Tri Phương - Phường Phú Nhuận - Thành phố Huế</h5></td>
                                            </tr>
                                            <tr>
                                                <td COLSPAN="5"><h5 class="text-center">Web: whitelotusrestaurant.com.vn</h5></td>
                                            </tr>
                                            <tr>
                                                <td COLSPAN="2"><h5 id="billDate" class="text-center">Ngày tháng: 28-05-2023</h5></td>
                                                <td COLSPAN="2"><h5 id="billStaff" class="text-center">Nhân viên: Thiên Phụng</h5></td>
                                                <td COLSPAN="1"><h5 id="billTable" class="text-center">Bàn: 05</h5></td>
                                            </tr>
                                            <tr>
                                                <td class="text-center" colspan="2">Sản phẩm</td>
                                                <td class="text-center">Số lượng</td>
                                                <td class="text-center">Giá</td>
                                                <td class="text-center">Thành tiền</td>
                                            </tr>

                                            </thead>
                                            <tbody>


                                            </tbody>
                                            <tfoot>
                                            <tr>
                                                <td COLSPAN="4"><h5 class="text-center">Tổng tiền</h5></td>
                                                <td COLSPAN="1"><h5 id="subAmount" class="text-center"></h5></td>
                                            </tr>
                                            <tr>
                                                <td COLSPAN="4"><h5 class="text-center">Phụ Thu</h5></td>
                                                <td COLSPAN="1"><h5 id="billCharge" class="text-center"></h5></td>
                                            </tr>
                                            <tr>
                                                <td COLSPAN="4"><h5 class="text-center">Giảm giá</h5></td>
                                                <td COLSPAN="1"><h5 id="billDis" class="text-center"></h5></td>
                                            </tr>
                                            <tr>
                                                <td COLSPAN="4"><h4 class="text-center">Chốt đơn</h4></td>
                                                <td COLSPAN="1"><h4 id="mainAmount" class="text-center"> </h4></td>
                                            </tr>
                                            <tr>
                                                <td COLSPAN="5"><h5 class="text-center">CẢM ƠN VÀ HẸN GẶP LẠI</h5></td>
                                            </tr>

                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </main>
        <!-- MAIN -->
    </section>
    <!-- CONTENT -->
    <style>
        table>thead>tr>th{
            background-color: #7266ba;
            color: white;
            border:  1px dashed black

        }
        table>thead>tr>td>h5,
        table>tfoot>tr>td>h5{
            text-align: center;
        }
        table>tbody>tr>td{
            border:  1px dashed black;
            color: #000;
        }
    </style>


    <!---- JAVA SCRIPT ---->
    <th:block th:replace="layout/javascript"/>
    <script>

        const page = {
            urls: {
                getBillById: AppBase.API_BILL,
                getOrderItemByOrderId: AppBase.API_ORDER


            },
            elements: {},
            loadData: {},
            commands: {},
            dialogs: {
                elements: {},
                loadData: {},
                commands: {},
            }
        }

        page.elements.id = $("#id");
        page.elements.createAt = $("#createAt");
        page.elements.staff = $("#staff");
        page.elements.table = $("#table");
        page.elements.orderPrice = $("#orderPrice");
        page.elements.charge = $("#charge");
        page.elements.discount = $("#discount");
        page.elements.totalAmount = $("#totalAmount");
        page.elements.statusOrder = $("#statusOrder");

        page.elements.tbOrderItemsBody = $("#tbOrderItems tbody")
        page.elements.loader = $(".bg-loading");

        page.elements.tbBill = $("#tbBill tbody")
        page.elements.billDate = $("#billDate");
        page.elements.billStaff = $("#billStaff");
        page.elements.billTable = $("#billTable");
        page.elements.subAmount = $("#subAmount");
        page.elements.billCharge = $("#billCharge");
        page.elements.billDis = $("#billDis");
        page.elements.mainAmount = $("#mainAmount");
        page.elements.cashPay = $("#cashPay");
        page.elements.transferPay = $("#transferPay");



        // ------------------------------------------------METHOD--------------------------------------------------------
        page.commands.getBillById = () => {
            page.commands.showLoading();

            let tempArray = location.href.split("/");
            let billId = tempArray.at(-1);

            return $.ajax({
                headers: {
                    // "Authorization": "Bearer "+ AppUtils.getCookie('JWT')
                },
                type: "GET",
                url: page.urls.getBillById + "/" + billId

            }).done((data) => {

                page.elements.id.text(data.id);
                page.elements.createAt.text(formDate(data.createdAt));
                page.elements.staff.text(data.staffName);
                page.elements.table.text(data.tableName);
                page.elements.orderPrice.text(formatCurrency(data.orderPrice));
                page.elements.charge.text(`${data.chargePercent}% - ${formatCurrency(data.chargeMoney)}`);
                page.elements.discount.text(`${data.discountPercent}% - ${formatCurrency(data.discountMoney)}`);
                page.elements.totalAmount.text(formatCurrency(data.totalAmount));


                data.status == "PAID" ?
                    page.elements.statusOrder.text("Đã thanh toán") :
                    page.elements.statusOrder.text("Chưa thanh toán");

                page.elements.billDate.text("Ngày Tháng: " + formDate(data.createdAt))
                page.elements.billStaff.text("Nhân viên: " +data.staffName);
                page.elements.billTable.text(data.tableName);
                page.elements.subAmount.text(formatCurrency(data.orderPrice));
                page.elements.billCharge.text(`${data.chargePercent}% - ${formatCurrency(data.chargeMoney)}`);
                page.elements.billDis.text(`${data.discountPercent}% - ${formatCurrency(data.discountMoney)}`);
                page.elements.mainAmount.text(formatCurrency(data.totalAmount));
                page.elements.cashPay.text(formatCurrency(data.cashPay));
                page.elements.transferPay.text(formatCurrency(data.transferPay));

                page.commands.getOrderItemByOrderId(data.orderId)
            })
                .fail((jqXHR) => {
                    let errors = jqXHR.responseJSON;
                    if (errors) {
                        let str = "";
                        $.each(errors, (k, v) => {
                            str += `
                            ${v}
                        `;
                        })
                        toastFail(str);
                    }
                })
        }

        function formatCurrency(input) {
            return new Intl.NumberFormat('vi-VN', {style: 'currency', currency: 'VND'}).format(input)
        }

        page.commands.getOrderItemByOrderId = (orderId) => {
            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json",
                    // "Authorization": "Bearer "+ AppUtils.getCookie('JWT')
                },
                type: "GET",
                url: page.urls.getOrderItemByOrderId + "/list-order-items/" + orderId
            }).done((data) => {
                console.log(data)

                if(data == undefined) toastFail("Chi tiết đơn hàng trống!");
                $.each(data, (i, item) => {
                    let image_thumbnail = `
                        ${AppBase.API_CLOUDINARY}/${AppBase.SCALE_IMAGE_W60_H50_Q100}/${item.product.productAvatar.fileFolder}/${item.product.productAvatar.fileName}
                    `;
                    let str = `
                    <tr>
                        <td class="user-avatar text-center">
                            <img
                                src="${image_thumbnail}"
                                alt="image"></td>
                        <td class="text-center">${item.product.title}</td>
                        <td class="text-center">${item.quantity}</td>
                        <td class="text-center">${item.note}</td>
                        <td class="text-center">${formatCurrency(item.price)}</td>
                        <td class="text-center">${formatCurrency(item.amount)}</td>
                    </tr>
                `
                    page.elements.tbOrderItemsBody.append(str);

                    let billStr = `
                    <tr>

                        <td class="text-center" colspan="2 ">${item.product.title}</td>
                        <td class="text-center">${item.quantity}</td>
                        <td class="text-center">${formatCurrency(item.price)}</td>
                        <td class="text-center">${formatCurrency(item.amount)}</td>
                    </tr>

                `
                    page.elements.tbBill.append(billStr);
                })
            })
                .fail((jqXHR) => {
                    let errors = jqXHR.responseJSON;
                    if (errors) {
                        let str = "";
                        $.each(errors, (k, v) => {
                            str += `
                        ${v}
                    `;
                        })
                        toastFail(str);
                    }
                })
                .always(function () {
                    page.commands.closeLoading();
                })
        }

        page.commands.closeLoading = () => {

            page.elements.loader.addClass("hide");
        }

        page.commands.showLoading = () => {

            page.elements.loader.removeClass("hide");
        }

        function formDate(date) {
            let arr = date.split("-")
            date = arr[2] + "-" + arr[1] + "-" + arr[0]
            return date;
        }

        function printContent(el){
            let restorepage = $('body').html();
            let printcontent = $('#' + el).clone();
            $('body').empty().html(printcontent);
            window.print();
            $('body').html(restorepage);
        }


        page.commands.loadData = () => {
            page.commands.getBillById();
        }


        $(() => {
            page.commands.loadData();

        });

    </script>


</body>

</html>